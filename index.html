<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Profile Picture Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for the "Inter" font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom styling for a vibrant, centered look */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e0e7f0 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>

<div class="max-w-md w-full bg-white p-6 md:p-8 shadow-2xl rounded-xl transform transition duration-500 hover:shadow-3xl">

    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
        Random Profile Picture
    </h1>
    <p class="text-center text-gray-500 mb-6">
        Generate a unique, realistic female portrait with random settings.
    </p>

    <!-- Image Display Area -->
    <div id="imageContainer" class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center shadow-inner mb-6">
        <img id="profileImage" src="https://placehold.co/512x512/3b82f6/ffffff?text=Click+Generate" alt="Generated Profile Picture" class="w-full h-full object-cover transition-opacity duration-300 opacity-100">

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="absolute inset-0 bg-white/70 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="spinner mb-3"></div>
            <p class="text-gray-700 font-medium">Generating image...</p>
        </div>
    </div>

    <!-- Generate Button -->
    <button id="generateButton" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Generate Profile Picture
    </button>

    <!-- Utility Buttons (Copy and Download) -->
    <div class="mt-3 flex space-x-2">
        <!-- Copy URL Button -->
        <button id="copyUrlButton" class="w-1/2 py-3 bg-gray-200 text-gray-800 text-sm font-bold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2.234M13 14h.01M17 14h.01M12 14h.01M16 18h.01M11 18h.01M15 18h.01" />
            </svg>
            Copy Data URI
        </button>
        
        <!-- Download Button -->
        <button id="downloadButton" class="w-1/2 py-3 bg-green-500 text-white text-sm font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Download (PNG)
        </button>
    </div>

    <!-- Status Messages -->
    <div id="copyStatusMessage" class="mt-2 text-center text-sm font-semibold h-5"></div>
    <div id="statusMessage" class="mt-4 text-center text-sm text-red-600 font-semibold h-5"></div>

</div>

<script type="module">
    // Constants for API interaction
    const MODEL_NAME = 'imagen-3.0-generate-002';
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:predict`;
    // --- THIS IS THE LINE TO EDIT ---
    const apiKey = "AIzaSyCMnWDP9A_EZpATePalULOtLVDLtRfRwgA"; // PASTE YOUR GEMINI API KEY HERE
    // --- ----------------------- ---

    // DOM Elements
    const generateButton = document.getElementById('generateButton');
    const copyUrlButton = document.getElementById('copyUrlButton');
    const downloadButton = document.getElementById('downloadButton'); // New element
    const profileImage = document.getElementById('profileImage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusMessage = document.getElementById('statusMessage');
    const copyStatusMessage = document.getElementById('copyStatusMessage');
    
    // Randomization arrays
    const TIMES_OF_DAY = [
        'golden hour', 'soft morning light', 'late evening', 'dramatic blue hour',
        'bright midday sun', 'overcast diffuse light', 'cozy night with warm lamps'
    ];
    const SETTINGS = [
        'rooftop garden with bokeh city background', 'stylish cafe interior',
        'urban street at night', 'natural light studio', 'seaside cliff at sunset',
        'modern art gallery', 'a busy market street'
    ];
    const ANGLES = [
        'close-up portrait', 'medium shot', 'low angle', 'high angle',
        'eye-level shot', 'shot from the side'
    ];
    const POSES = [
        'natural, candid smile looking at the camera', 'pensive expression looking away',
        'subtle laughing expression with wind in hair', 'relaxed pose, hands near face',
        'hands in pockets, casual look'
    ];

    /**
     * Helper function to get a random element from an array.
     * @param {Array<string>} arr - The array to pick from.
     * @returns {string} - A random element.
     */
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    /**
     * Generates a randomized prompt based on user requirements.
     * @returns {string} - The complete randomized prompt.
     */
    function createRandomPrompt() {
        const time = getRandomElement(TIMES_OF_DAY);
        const setting = getRandomElement(SETTINGS);
        const angle = getRandomElement(ANGLES);
        const pose = getRandomElement(POSES);

        // Constructing the detailed prompt
        const prompt = `A hyper-realistic, photorealistic social media profile picture of a young adult female, 
            ${pose}, captured during the ${time} in a ${setting}. ${angle}. 
            Professional photography, 8k, extremely detailed, no coffee or props in hand.`;
        
        console.log("Generated Prompt:", prompt);
        return prompt;
    }

    /**
     * Converts a delay in seconds to milliseconds.
     * @param {number} delaySeconds - The delay in seconds.
     * @returns {number} - The delay in milliseconds.
     */
    const delay = (delaySeconds) => new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));

    /**
     * Fetches the image from the Imagen API with exponential backoff.
     */
    async function generateImage() {
        // 1. Setup UI for loading state
        generateButton.disabled = true;
        copyUrlButton.disabled = true; 
        downloadButton.disabled = true; // Disable download button while generating
        loadingIndicator.style.opacity = '1';
        loadingIndicator.style.pointerEvents = 'auto';
        statusMessage.textContent = '';
        copyStatusMessage.textContent = ''; 
        profileImage.style.opacity = '0.5';

        const prompt = createRandomPrompt();
        const maxRetries = 5;
        let attempt = 0;
        let success = false;

        while (attempt < maxRetries) {
            try {
                const payload = {
                    instances: [{ prompt: prompt }],
                    parameters: { "sampleCount": 1 }
                };

                // NOTE: If apiKey is empty, this call relies on the runtime environment to provide it.
                // For external hosting (like GitHub Pages), the user MUST replace "" with their actual key.
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // Conditionally include API key header if it's set
                        ...(apiKey && { 'x-api-key': apiKey })
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        // 2. Update the image source
                        profileImage.src = `data:image/png;base64,${base64Data}`;
                        profileImage.alt = "Generated Profile Picture";
                        statusMessage.textContent = '';
                        success = true;
                        break; // Exit loop on success
                    } else {
                        throw new Error('Image data not found in API response.');
                    }
                } else {
                    // Check for rate limit (429) or other errors
                    const errorData = await response.json();
                    console.error(`API Error on attempt ${attempt + 1}:`, errorData);
                    
                    if (response.status === 429 && attempt < maxRetries - 1) {
                        // Exponential backoff
                        const waitTime = Math.pow(2, attempt) + Math.random(); // 1s, 2s, 4s, 8s, 16s + jitter
                        statusMessage.textContent = `Rate limit hit. Retrying in ${waitTime.toFixed(1)} seconds...`;
                        attempt++;
                        await delay(waitTime);
                        continue;
                    } else {
                        throw new Error(`Failed to generate image (Status: ${response.status})`);
                    }
                }
            } catch (error) {
                console.error('Image Generation Error:', error);
                statusMessage.textContent = `Error generating image: ${error.message}. Please try again.`;
                break; // Stop trying on unexpected errors
            }
        }

        // 3. Reset UI state
        generateButton.disabled = false;
        loadingIndicator.style.opacity = '0';
        loadingIndicator.style.pointerEvents = 'none';
        profileImage.style.opacity = '1';
        
        if (success) {
             copyUrlButton.disabled = false; 
             downloadButton.disabled = false; // Enable download button on success
        } else if (attempt === maxRetries) {
            statusMessage.textContent = 'Maximum retries reached. The service may be busy. Please try again later.';
        }
    }

    /**
     * Handles copying the Base64 Data URI to the clipboard.
     */
    function handleCopyUrl() {
        const imageUrl = profileImage.src;
        // Check if the current image is the placeholder
        if (imageUrl.includes('placehold.co')) {
            copyStatusMessage.textContent = 'Generate an image first.';
            copyStatusMessage.classList.remove('text-green-600');
            copyStatusMessage.classList.add('text-red-600');
            return;
        }

        try {
            // Use the robust fallback method (document.execCommand('copy'))
            const textArea = document.createElement("textarea");
            textArea.value = imageUrl;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            document.execCommand('copy');
            
            document.body.removeChild(textArea);

            copyStatusMessage.textContent = 'Data URI copied to clipboard!';
            copyStatusMessage.classList.remove('text-red-600');
            copyStatusMessage.classList.add('text-green-600');

            setTimeout(() => {
                copyStatusMessage.textContent = '';
            }, 3000);

        } catch (err) {
            console.error('Failed to copy text: ', err);
            copyStatusMessage.textContent = 'Error: Failed to copy URI.';
            copyStatusMessage.classList.remove('text-green-600');
            copyStatusMessage.classList.add('text-red-600');
        }
    }

    /**
     * Handles downloading the generated image as a PNG file.
     */
    function handleDownloadImage() {
        const imageUrl = profileImage.src;

        // Check for placeholder
        if (imageUrl.includes('placehold.co')) {
            copyStatusMessage.textContent = 'Generate an image first to download.';
            copyStatusMessage.classList.remove('text-green-600');
            copyStatusMessage.classList.add('text-red-600');
            return;
        }

        try {
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `profile_picture_${Date.now()}.png`; // Set filename with timestamp

            // Append to body, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            copyStatusMessage.textContent = 'Download started!';
            copyStatusMessage.classList.remove('text-red-600');
            copyStatusMessage.classList.add('text-green-600');
            
            setTimeout(() => {
                copyStatusMessage.textContent = '';
            }, 3000);

        } catch (err) {
            console.error('Failed to download image:', err);
            copyStatusMessage.textContent = 'Error: Download failed.';
            copyStatusMessage.classList.remove('text-green-600');
            copyStatusMessage.classList.add('text-red-600');
        }
    }


    // Event Listeners
    generateButton.addEventListener('click', generateImage);
    copyUrlButton.addEventListener('click', handleCopyUrl);
    downloadButton.addEventListener('click', handleDownloadImage); // New listener

    // Initial message on load
    window.onload = () => {
        console.log('Profile Picture Generator loaded.');
    };

</script>
</body>
</html>